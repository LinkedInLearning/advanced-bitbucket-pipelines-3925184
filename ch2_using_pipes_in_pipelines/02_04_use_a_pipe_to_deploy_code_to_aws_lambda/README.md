# 02_04 Use a pipe to deploy code to AWS Lambda

This lesson uses the CloudFormation stack from the previous lesson, [02_03 Deploy Lambda Functions in AWS](../02_03_deploy_lambda_functions_in_aws/README.md).

The outputs generated by the CloudFormation stack are need to configure deployment and repository variables for deploying to AWS.

## 1. Retrieve the CloudFormation Stack Outputs

1. **Log in to AWS Console:** Navigate to the CloudFormation console and select the stack you deployed in the previous lesson.

1. **View Outputs:** Go to the **Outputs** tab of your stack. You should see values for the following:

   | Output Name            | Description                                 |
   |------------------------|---------------------------------------------|
   | StagingFunctionName    | _YourStackName-staging_                     |
   | StagingURL             | The URL for your staging Lambda function    |
   | ProductionFunctionName | _YourStackName-production_                  |
   | ProductionURL          | The URL for your production Lambda function |
   | AwsAccessKeyId         | The access key for your service account     |
   | AwsSecretAccessKey     | The corresponding secret key                |
   | AwsDefaultRegion       | The AWS region where your stack is deployed |

   Make a note of these values for the following steps.

## 2. Configure Deployment Variables for the Staging and Production Environments

The pipeline configuration for this lesson uses environment-specific variables (like `$FUNCTION_NAME` and `$URL`) during deployment. These variables are referenced in your pipeline’s deploy step, ensuring that the correct Lambda function is updated during each deployment stage.

Here’s how to set these up in Bitbucket:

### Staging Deployment Variables

1. **Access the Repository Settings:** In Bitbucket, navigate to your repository and click on **Settings**.

1. **Go to Pipelines – Deployments:** Under **Pipelines**, select **Deployments** and then choose the **Staging** environment.

1. **Add Environment Variables:**

   - **FUNCTION_NAME:** Paste the value from CloudFormation’s **StagingFunctionName**.
   - **URL:** Paste the value from CloudFormation’s **StagingURL**.

1. **Save** the changes.

### Production  Deployment Variables

1. **Select the Production Environment:**  In the same **Deployments** section, choose the **Production** environment.

1. **Add Environment Variables:**

   - **FUNCTION_NAME:** Paste the value from CloudFormation’s **ProductionFunctionName**.
   - **URL:** Paste the value from CloudFormation’s **ProductionURL**.

1. **Save** the changes.

## 3. Configure Repository Variables for AWS Credentials

Since your pipeline uses AWS credentials to deploy (via the Atlassian AWS Lambda Deploy pipe), these credentials should be stored as secured repository variables.  These repository-level variables ensure that every pipeline run can authenticate with AWS without exposing your credentials.

1. **Navigate to Repository Variables:**

   From your Bitbucket repository, go to **Settings** and then select **Pipelines > Repository variables**.

1. **Add the AWS Credentials:**

   - **AWS_ACCESS_KEY_ID:** Add a new variable and paste the value from the CloudFormation output **AwsAccessKeyId**. Mark it as _secured_.
   - **AWS_SECRET_ACCESS_KEY:** Add a new secured variable with the value from **AwsSecretAccessKey**.
   - **AWS_DEFAULT_REGION:** Add this as a normal variable with the value from **AwsDefaultRegion**.

1. **Save** all the variables.

## 4. Validate Your Setup

> [!NOTE]
> Pushing a change to the `main` branch will deploy to the `Production` environment.
> Pushing a change to any other branch will deploy to the `Staging` environment.

1. **Commit a Change:** Push a change to your repository (or trigger a manual pipeline if on the main branch) to see that the deployment steps pick up the correct variables.

1. **Monitor the Pipeline:** Check the Bitbucket Pipelines logs to verify that the environment variables are being correctly applied, and that the deployment steps are using the right function names and URLs.

1. **Observe the Updated URL:** Open the URL for the updated function environment to confirm a change has been applied.

By following these steps, you configure your Bitbucket repository to automatically use the CloudFormation output values, allowing your pipeline to deploy updates to the correct Lambda functions in both staging and production environments while securely managing your AWS credentials.

<!-- FooterStart -->
---
[← 02_03 Deploy Lambda Functions in AWS](../02_03_deploy_lambda_functions_in_aws/README.md) | [02_05 Challenge: Use Pipes in a Pipeline →](../02_05_challenge_use_pipes_in_a_pipeline/README.md)
<!-- FooterEnd -->
