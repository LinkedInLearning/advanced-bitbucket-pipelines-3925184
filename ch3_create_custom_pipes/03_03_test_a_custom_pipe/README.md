# 03_03 Test a Custom Pipe

## Getting Started

Running the `yo bitbucket-pipe` command creates template code and a test suite for developing and testing a custom pipe.

Before testing a custom pipe (particularly a pipe created with the `bitbucket-pipe` generator), you need to have the following in place:

| Application                                                          | Command to confirm installation |
|----------------------------------------------------------------------|--------------------------------|
| [Docker CLI](https://www.docker.com/products/cli/)                   | `docker --version`             |
| [Pytest](https://docs.pytest.org/en/stable/)                         | `pytest --version`             |
| [BATS](https://bats-core.readthedocs.io/en/stable/installation.html) | `bats --version`               |

> [!IMPORTANT]
> To install `pytest` run `pip install --requirement test/requirements.txt` from the root of the repository
> Install `docker` and `bats` using the application or package manager for your system.

## The Test Suites

Review the generated test suites to see how they include:

- Functions that build a local docker image for running tests
- One or more functions that tests the code generated by the template

| Pipe template   | Test Suite                                     |
|-----------------|------------------------------------------------|
| advanced-python | [test/test.py](./advanced-python/test/test.py)   |
| advanced-bash   | [test/test.bats](./advanced-bash/test/test.bats) |

> [!IMPORTANT]
> The simple pipe templates do not include a test suite.
> All the more reason to start with the advanced options! :D

## Running the Test Suites

> [!NOTE]
> Review the Shenanigans for `pytest` versions

| Pipe template | Test command |
|-----------------|----------------------------------|
| advanced-python | `pytest --verbose test/test*.py` |
| advanced-bash   | `bats test/test.bats`            |

### Python Test Output

```bash
========================================================= test session starts ==========================================================
platform darwin -- Python 3.10.16, pytest-7.2.1, pluggy-1.0.0 -- /opt/homebrew/opt/python@3.10/bin/python3.10
cachedir: .pytest_cache
rootdir: .../advanced-python
plugins: anyio-3.6.2
collected 2 items

test/test.py::test_no_parameters PASSED                                                                                          [ 50%]
test/test.py::test_success PASSED                                                                                                [100%]

========================================================== 2 passed in 2.42s ===========================================================
```

### Bash Test Output

```bash
bats test/test.bats
test.bats
 ✓ Dummy test

1 test, 0 failures
```

## Shenanigans

### 03_03.1: The `setup()` Function is Treated Differently by Different Versions of `pytest`

- Older versions of `pytest` will call the `setup()` function before each test by default

- Newer versions of `pytest` require the function to be named `setup_function()`.

- If you get failures in your test suite, check the version of `pytest` and make changes to the setup function as needed.

Reference: [regression in pytest 8.1.1: module level setup function doesn't seem to be run #12113](https://github.com/pytest-dev/pytest/issues/12113)

### 03_03.2: Tests Create Compiled Bytecode but the Files Aren't Ignored

The `bitbucket-pipe` generator creates a `.gitignore` file that's meager by modern development standards:

```bash
.idea
*.iml
```

If you didn't add a Python `.gitignore` when you created the repo, you might see something similar to the following after running Python tests and then running `git status`:

```bash
Untracked files:
  (use "git add <file>..." to include in what will be committed)
	test/__pycache__/test.cpython-313-pytest-7.2.2.pyc
```

The workaround is to update `.gitignore` to keep *.pyc files out of the repo;

```bash
# Compiled Python bytecode
*.py[cod]
```

<!-- FooterStart -->
---
[← Bitbucket Pipelines Pipe: example](../03_02_develop_a_custom_pipe/advanced-python/README.md) | [03_04 Deploy a Custom Pipe to a Container Registry →](../03_04_deploy_a_custom_pipe_to_a_container_registry/README.md)
<!-- FooterEnd -->
